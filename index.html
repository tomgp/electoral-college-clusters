<!DOCTYPE html>
<meta charset="utf-8">
<style>
body{
    font-family: sans-serif;
    background: #212121;
    color: #FFF;
}

.land{
    fill:#e4e4e4;
}

.border-glow{
    fill:none;
    stroke:#212121;
    filter: url(#glow);
}

.state-boundary{
    fill: none;
    stroke:#212121;

}

hr{
    border: none;
    border-top: dotted 1px black;
}

.r-winner{
    fill:none;
    stroke:none;
}

.d-winner{
    fill:none;
    stroke:none;
}

.r-winner{
    fill: none;
    stroke: none;
}

.d-winner{
    fill: none;
    stroke: none;
}

.land-shadow{
    fill:#FFF;
    stroke: #444;
}

.state-result{
    fill:none;
}

.r-winner.show-stateresult{
    fill: #de272a;
    stroke: none;
}

.d-winner.show-stateresult{
    fill: #238fce;
    stroke: none;
}

svg{
    border: solid 1px white;
}
.graphic{
    padding: 30px;
}

.annotations{
    stroke: #FFF;
    stroke-width:5px;
    stroke-opacity:0.5;
}

.estimate{
    fill-opacity:1;
}

</style>
<h1>Result map sketch</h1>
<button id="display-switch" type="">show block</button>
<br>
<div class="graphic">
<svg width="800" height="400" viewBox="0 0 960 500"></svg>
</div>
<hr>
<a href="index.html">about</a> <a href="https://github.com/tomgp/electoral-college-clusters">source code on gihub</a>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="d3-iconarray.js"></script>
<script>

var svg = d3.select('svg');


var barScale = d3.scaleLinear()
    .range([0, 1200])
    .domain([0, 100]);

var roffset = { x:100, y:340 };
var doffset = { x:100, y:roffset.y + barScale(6) };
var margin = { top:10, left:10 };

svg.append('g')
    .attr('opacity',0)
    .classed('annotations',true)
    .append('line')
    .attr('x1',barScale(270/5) + roffset.x + margin.left)
    .attr('x2',barScale(270/5) + roffset.x + margin.left)
    .attr('y1',roffset.y + margin.top)
    .attr('y2',roffset.y + margin.top +barScale(11));

var radius = 3;
var projection = d3.geoAlbersUsa();
var colour = {
    r:'#de272a', //#ee3339   #e44950   #f69c92 
    d:'#238fce', // #1f90cf   #509bd2   #94bada 
};

var mapColour = {
    r:'#f69c92', //#ee3339   #e44950    
    d:'#94bada', // #1f90cf   #509bd2   
}

var path = d3.geoPath()
    .projection(projection);
var margin = {top:10, left:10};
var mapLayer = svg.append('g').attr('class','map');
var dotLayer = svg.append('g').attr('class','dots');
var mode = 0;



d3.csv('result-2016.csv', function(error,data){

    d3.json('us.json', function(err, topoData){
        mapLayer.call(drawMap, topoData, data);
    });

    var projected = data.map( function(d){
			[x, y] = projection([d.longitude, d.latitude])
			return { 
				originx:x,
				originy:y,
				state: d.state,
                liveestimate: d.liveestimate,
				votes: Number(d.votes),
                winner: d.winner,
			}
		});

    var expanded = expand(projected, 'votes')
        .sort(function(a, b){
            if(a.liveestimate == 'TRUE') return 1;
            if(b.liveestimate == 'TRUE') return -1;            
            return 0;
        });

    console.log(projected);

    var layout = d3_iconarray.layout()
        .height(5)
        .widthFirst(false);

    //split the array and grid layout each half
    var rgrid = layout(expanded.filter((d) => d.winner.indexOf('r')>-1));
    var dgrid = layout(expanded.filter((d) => d.winner.indexOf('d')>-1));
    var grid = rgrid.concat(dgrid);

    plot(null, grid);
});

function plot(error, data){
  if (error) throw error;
  console.log(data);
  var simulation = d3.forceSimulation(data)
      .force('x', d3.forceX(function(d) { return d.data.originx; }).strength(1))
      .force('y', d3.forceY(function(d) { return d.data.originy; }).strength(0.5))
      .force('collide', d3.forceCollide(5) )
      .stop();

  for (var i = 0; i < 250; ++i) simulation.tick();

  dotLayer.append('g')
        .attr('class', 'cells')
            .selectAll('g')
        .data(data)
            .enter()
        .append('g')
        .append('circle')
            .attr('class',function(d){
                if(Â d.data.liveestimate === 'TRUE' ) return 'college-vote estimate';
                return 'college-vote';
            })
        .call(layoutByDotMap);
    

    
    d3.select('#display-switch').on('click',function(){
        var t = d3.transition()
            .duration(2000)
            .ease(d3.easeExpOut);


        if (mode == 0){
            mode = 1;
            d3.select(this).text('show dot map');
            d3.selectAll('circle.college-vote')
                .transition(t)
                .call(layoutByArray);
            d3.selectAll('path.state-result').classed('show-stateresult', true);
            d3.select('g.map').transition(t).attr('transform', 'scale(0.6) translate(320,0)');
            d3.select('g.annotations').transition(t).attr('opacity',1);
        }else{
            mode = 0;
            d3.select(this).text('show bars');
            d3.selectAll('circle.college-vote')
                .transition(t)
                .call(layoutByDotMap);
                
            d3.selectAll('path.state-result').classed('show-stateresult', false);
            d3.select('g.map').transition(t).attr('transform', 'scale(1)');
            d3.select('g.annotations').transition(t).attr('opacity',0);
        }
        console.log('switch');
    });
}

function drawMap(parent, us, result) {

        parent.append('path')
            .datum(topojson.feature(us, us.objects.land))
            .attr('class', 'land-shadow')
            .attr('d', path);

        parent.append('path')
            .datum(topojson.feature(us, us.objects.land))
            .attr('class', 'land')
            .attr('d', path);

        parent.selectAll('path.state-result')
            .data(topojson.feature(us, us.objects.states).features)
            .enter()
                .append('path')
                .attr('d', path)
                .attr('class', function(d){
                    var state = result.find(function(s){
                        return (d.id == s.fips);
                    });
                    if(state) return state.winner + '-winner state-result';  
                    return '';
                });
            

        parent.append('path')
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr('class', 'border-glow')
            .attr('d', path);

        parent.append('path')
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr('class', 'state-boundary')
            .attr('d', path);

}

function layoutByArray(parentSelection){


    parentSelection
        .attr('r', radius)
        .attr('cx', function(d) { 
            if(d.data.winner == 'r'){
                return barScale(d.position.x)+margin.left + roffset.x;
            }
            if(d.data.winner == 'd'){
                return barScale(d.position.x)+margin.left + doffset.x;
            }
        })
        .attr('cy', function(d) { 
            if(d.data.winner == 'r'){
                return barScale(d.position.y)+margin.left + roffset.y;
            }
            if(d.data.winner == 'd'){
                return barScale(d.position.y)+margin.left + doffset.y;
            }
        })
        .attr('r',5)
        .attr('fill', function(d){ 
            if (!d.data.winner) return '#000';
            return colour[d.data.winner]; })
        .attr('stroke', function(d){ 
            if (!d.data.winner) return '#bbb';
            return 'none'; 
        });
}

function layoutByDotMap(parentSelection){
    parentSelection.attr('r', radius)
        .attr('cx', function(d) { return d.x; })
        .attr('cy', function(d) { return d.y; })
        .attr('fill', function(d){ 
            if (!d.data.winner) return '#999';
            return colour[d.data.winner]; })
        .attr('stroke', function(d){ 
            if (!d.data.winner) return '#bbb';
            return 'none'; 
        });
}

function expand(arr, counter){ 
    return arr.reduce(function(value, d){
        for(var i=0;i<d[counter];i++){

            value.push(JSON.parse( JSON.stringify(d)));
        }
        return value;
    }, []);
}

</script>
